<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BIT BUILDERS — Round 3 Unlock</title>

  <!-- fonts & libs -->
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rubik:wght@400;500&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/tsparticles@3/tsparticles.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <!-- external stylesheet -->
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <!-- Intro overlay -->
  <div id="intro" class="intro">
    <div class="boot">
      <div class="boot-title">INITIALIZING</div>
      <div class="boot-sub">BIT BUILDERS SYSTEM</div>
      <div class="boot-loader"><span></span></div>
    </div>
  </div>

  <!-- particles -->
  <div id="tsparticles" aria-hidden="true"></div>

  <!-- hero header -->
  <header class="hero">
    <div class="hero-inner">
      <div class="logo">BB</div>
      <div class="hero-text">
        <h1>BIT BUILDERS</h1>
        <p>Round 3 — The Ultimate Unlock Challenge</p>
      </div>
      <div class="hero-actions">
        <label for="sound" class="sound-label">Sound</label>
        <input id="sound" type="checkbox" checked aria-label="Toggle feedback sounds">
      </div>
    </div>
  </header>

  <!-- main card -->
  <main class="main">
    <section class="card" role="application" aria-label="Unlock panel">
      <div class="left">
        <div class="controls-top">
          <div class="modes" role="tablist" aria-label="Input mode">
            <button id="multiMode" class="mode active" type="button">Multi (20 boxes)</button>
            <button id="singleMode" class="mode" type="button">Single field</button>
          </div>
          <button id="btnHelp" class="mode help" type="button">Help</button>
        </div>

        <p class="hint">Auto-tab & paste-friendly — paste all letters into the first box or use single field. Only A–Z / 0–9 are considered.</p>

        <div id="multiArea">
          <div id="grid" class="grid" aria-label="Twenty letter inputs"></div>
        </div>

        <div id="singleArea" class="single-area" style="display:none">
          <input id="singleInput" class="singleField" type="text" maxlength="40" placeholder="Type or paste all 20 letters here" aria-label="Single input for all letters" />
        </div>

        <div class="progressWrap" aria-hidden="true">
          <div class="progress" id="progress"></div>
        </div>

        <div class="actions">
          <button id="btnUnlock" class="primary" type="button">Unlock</button>
          <button id="btnClear" class="ghost" type="button">Clear</button>
          <button id="btnPaste" class="ghost" type="button">Paste</button>
        </div>

        <div id="status" class="status" aria-live="polite"></div>
      </div>

      <aside class="right" aria-live="polite">
        <div class="secret-title">Secret Access</div>

        <div id="revealMsg" class="reveal-msg">Access Granted — Proceed to the Next Stage</div>

        <div class="imageWrap">
          <div id="imageBox" class="imageBox" aria-hidden="true">
            <img id="secretImage" src="files/qr.png" alt="Secret access image (revealed on success)" style="display:none" />
          </div>
        </div>
      </aside>

      <div class="overlay">
        <div id="scanner" class="scanner"><div class="bar"></div></div>
      </div>
    </section>
  </main>

  <script>
  /* ========= CONFIG ========= */
  const REQUIRED = 20;
  const KEY_PATH = 'files/key.txt';

  /* ========= DOM ========= */
  const grid = document.getElementById('grid');
  const multiArea = document.getElementById('multiArea');
  const singleArea = document.getElementById('singleArea');
  const singleInput = document.getElementById('singleInput');
  const btnUnlock = document.getElementById('btnUnlock');
  const btnClear = document.getElementById('btnClear');
  const btnPaste = document.getElementById('btnPaste');
  const status = document.getElementById('status');
  const progress = document.getElementById('progress');
  const imageBox = document.getElementById('imageBox');
  const secretImage = document.getElementById('secretImage');
  const revealMsg = document.getElementById('revealMsg');
  const scanner = document.getElementById('scanner');
  const multiMode = document.getElementById('multiMode');
  const singleMode = document.getElementById('singleMode');
  const soundToggle = document.getElementById('sound');
  const btnHelp = document.getElementById('btnHelp');

  /* ========= Audio (WebAudio) ========= */
  const AudioContext = window.AudioContext || window.webkitAudioContext;
  const audioCtx = AudioContext ? new AudioContext() : null;
  function clickTone(){ if(!soundToggle.checked || !audioCtx) return; const now=audioCtx.currentTime; const o=audioCtx.createOscillator(); const g=audioCtx.createGain(); o.type='sine'; o.frequency.setValueAtTime(900,now); g.gain.setValueAtTime(0.0005,now); g.gain.exponentialRampToValueAtTime(0.06,now+0.01); g.gain.exponentialRampToValueAtTime(0.0005,now+0.12); o.connect(g); g.connect(audioCtx.destination); o.start(now); o.stop(now+0.12);}
  function successTone(){ if(!soundToggle.checked || !audioCtx) return; const now=audioCtx.currentTime; const o1=audioCtx.createOscillator(), o2=audioCtx.createOscillator(), g=audioCtx.createGain(); o1.type='sine'; o2.type='sine'; o1.frequency.setValueAtTime(440,now); o2.frequency.setValueAtTime(660,now); g.gain.setValueAtTime(0.001,now); g.gain.linearRampToValueAtTime(0.18,now+0.02); g.gain.linearRampToValueAtTime(0.001,now+0.8); o1.connect(g); o2.connect(g); g.connect(audioCtx.destination); o1.start(now); o2.start(now); o1.stop(now+0.8); o2.stop(now+0.8); }
  function failTone(){ if(!soundToggle.checked || !audioCtx) return; const now=audioCtx.currentTime; const o=audioCtx.createOscillator(), g=audioCtx.createGain(); o.type='triangle'; o.frequency.setValueAtTime(220,now); g.gain.setValueAtTime(0.0005,now); g.gain.linearRampToValueAtTime(0.06,now+0.02); g.gain.linearRampToValueAtTime(0.0005,now+0.22); o.connect(g); g.connect(audioCtx.destination); o.start(now); o.stop(now+0.22); }

  /* ========= Helpers ========= */
  function normalize(s){ return (s||'').toUpperCase().replace(/[^A-Z0-9]/g,''); }

  /* ========= Build multi inputs ========= */
  function buildBoxes(n=REQUIRED){
    grid.innerHTML = '';
    for(let i=0;i<n;i++){
      const c = document.createElement('div'); c.className='cell';
      const inp = document.createElement('input'); inp.type='text'; inp.maxLength=2; inp.dataset.index=i; inp.setAttribute('aria-label','Letter '+(i+1));
      c.appendChild(inp); grid.appendChild(c);

      inp.addEventListener('input', (e)=>{
        clickTone();
        const v = e.target.value;
        if(v.length > 1){ distributePaste(v, parseInt(e.target.dataset.index)); return; }
        e.target.value = normalize(v).slice(0,1);
        updateProgress();
        const idx = parseInt(e.target.dataset.index);
        if(e.target.value && idx < REQUIRED-1){
          const next = grid.querySelector('input[data-index="'+(idx+1)+'"]'); if(next) next.focus();
        }
      });

      inp.addEventListener('keydown', (ev)=>{
        const idx = parseInt(ev.target.dataset.index);
        if(ev.key === 'Backspace' && !ev.target.value){
          const prev = grid.querySelector('input[data-index="'+(idx-1)+'"]'); if(prev){ prev.focus(); prev.value=''; updateProgress(); ev.preventDefault(); }
        } else if(ev.key === 'ArrowLeft'){ const prev = grid.querySelector('input[data-index="'+(idx-1)+'"]'); if(prev) prev.focus(); ev.preventDefault(); }
        else if(ev.key === 'ArrowRight'){ const nxt = grid.querySelector('input[data-index="'+(idx+1)+'"]'); if(nxt) nxt.focus(); ev.preventDefault(); }
      });
    }
    updateProgress();
  }

  function distributePaste(txt, start){
    const chars = normalize(txt).split('');
    for(let i=0;i<chars.length;i++){
      const idx = start + i;
      const inp = grid.querySelector('input[data-index="'+idx+'"]'); if(!inp) break; inp.value = chars[i];
    }
    updateProgress();
    for(let j=start;j<REQUIRED;j++){ const inp = grid.querySelector('input[data-index="'+j+'"]'); if(inp && !inp.value){ inp.focus(); return; } }
    const last = grid.querySelector('input[data-index="'+(REQUIRED-1)+'"]'); if(last) last.focus();
  }

  /* ========= Single field handling (sound + progress) ========= */
  function singleInputListener(){
    clickTone();           // play tone for single field
    const v = normalize(singleInput.value).slice(0,REQUIRED);
    const boxes = grid.querySelectorAll('input');
    for(let i=0;i<boxes.length;i++) boxes[i].value = v[i]||'';
    updateProgress();
  }
  singleInput.addEventListener('input', singleInputListener);

  /* ========= Common helpers ========= */
  function getCombined(){
    if(multiArea.style.display !== 'none'){
      return Array.from(grid.querySelectorAll('input')).map(i => normalize(i.value).slice(0,1)).join('');
    } else {
      return normalize(singleInput.value).slice(0,REQUIRED);
    }
  }

  function updateProgress(){
    const s = getCombined();
    const filled = s.replace(/[^A-Z0-9]/g,'').length;
    const pct = Math.min(100, Math.round((filled/REQUIRED)*100));
    progress.style.width = pct + '%';
  }

  // paste distribution when user pastes into first multi input
  document.addEventListener('paste', (ev)=>{
    const active = document.activeElement;
    if(active && active.dataset && typeof active.dataset.index !== 'undefined'){
      setTimeout(()=> { const first = grid.querySelector('input[data-index="0"]'); if(first && first.value.length > 1) distributePaste(first.value,0); }, 10);
    }
  });

  /* ========= Mode toggles & UI ========= */
  multiMode.addEventListener('click', ()=> setMode('multi'));
  singleMode.addEventListener('click', ()=> setMode('single'));
  btnHelp.addEventListener('click', ()=> alert("Round 3 — Enter the first letter of each answer in order. Paste supported."));

  function setMode(m){
    if(m === 'multi'){
      multiArea.style.display = '';
      singleArea.style.display = 'none';
      multiMode.classList.add('active');
      singleMode.classList.remove('active');
      // sync single->multi
      const v = normalize(singleInput.value).slice(0,REQUIRED);
      const boxes = grid.querySelectorAll('input');
      for(let i=0;i<boxes.length;i++) boxes[i].value = v[i]||'';
    } else {
      multiArea.style.display = 'none';
      singleArea.style.display = '';
      singleMode.classList.add('active');
      multiMode.classList.remove('active');
      // sync multi->single
      const v2 = Array.from(grid.querySelectorAll('input')).map(i => normalize(i.value).slice(0,1)).join('');
      singleInput.value = v2.slice(0,REQUIRED);
    }
    hideReveal();
    updateProgress();
    status.textContent = '';
  }

  btnClear.addEventListener('click', ()=>{ Array.from(grid.querySelectorAll('input')).forEach(i=>i.value=''); singleInput.value=''; status.textContent=''; progress.style.width='0%'; hideReveal(); const f = grid.querySelector('input[data-index="0"]'); if(f) f.focus(); });

  btnPaste.addEventListener('click', ()=> { const txt = prompt("Paste the 20 letters (they will distribute):"); if(!txt) return; distributePaste(txt,0); });

  document.addEventListener('keydown', (e)=> { if(e.key === 'Enter') btnUnlock.click(); });

  /* ========= Fetch key & verify ========= */
  async function fetchKey(){
    try{
      const res = await fetch(KEY_PATH, {cache:'no-store'});
      if(!res.ok) throw new Error('key fetch failed');
      const text = (await res.text()).trim();
      return normalize(text);
    }catch(err){ console.error('key fetch error', err); return null; }
  }

  function showScanner(){ scanner.classList.add('active'); }
  function hideScanner(){ scanner.classList.remove('active'); }

  async function verify(){
    const candidate = getCombined();
    if(candidate.length !== REQUIRED){ fail(`Enter exactly ${REQUIRED} letters (${candidate.length} entered).`); return; }

    status.textContent = 'Verifying...'; status.className = 'status';
    showScanner();
    await new Promise(r=>setTimeout(r, 800)); // scanning feel
    const key = await fetchKey();
    hideScanner();
    if(key === null){ fail('Unable to fetch the code.'); return; }
    if(candidate === key) succeed(); else fail('Incorrect code — try again.');
  }

  btnUnlock.addEventListener('click', verify);

  function succeed(){
    status.className = 'status ok';
    status.textContent = '';
    revealMsg.classList.add('show');
    successTone();
    setTimeout(()=> {
      imageBox.classList.add('revealed');
      secretImage.style.display = 'block';
      confetti({ particleCount: 120, spread: 90, origin: { y: 0.65 } });
    }, 520);
  }

  function fail(msg){
    status.className = 'status fail';
    status.textContent = msg || 'Incorrect';
    document.querySelector('.left').classList.add('shake');
    setTimeout(()=> document.querySelector('.left').classList.remove('shake'), 600);
    failTone();
  }

  function hideReveal(){
    revealMsg.classList.remove('show');
    imageBox.classList.remove('revealed');
    secretImage.style.display = 'none';
  }

  /* ========= Particles init ========= */
  (function(){
    tsParticles.load("tsparticles", {
      fullScreen: { enable: true, zIndex: -1 },
      detectRetina: true,
      fpsLimit: 60,
      particles: {
        number: { value: 48, density: { enable: true, area: 900 } },
        color: { value: ["#00ffe0","#6a5cff","#00b8ff"] },
        shape: { type: "circle" },
        opacity: { value: 0.45, random: { enable: true, minimumValue: 0.12 } },
        size: { value: { min: 1, max: 3 } },
        links: { enable: true, distance: 120, color: "#00ffe0", opacity: 0.06, width: 1 },
        move: { enable: true, speed: 0.6, outModes: "out" }
      },
      interactivity: {
        events: { onHover: { enable: true, mode: "grab" }, onClick: { enable: true, mode: "push" } },
        modes: { grab: { distance: 160, links: { opacity: 0.12 } }, push: { quantity: 3 } }
      }
    });
  })();

  /* ========= Intro boot animation ========= */
  (function introBoot(){
    const intro = document.getElementById('intro');
    setTimeout(()=> intro.classList.add('fadeOut'), 1400);
    setTimeout(()=> intro.style.display = 'none', 2000);
  })();

  /* ========= Init ========= */
  buildBoxes();
  hideReveal();
  updateProgress();
  setTimeout(()=> { const f = grid.querySelector('input[data-index="0"]'); if(f) f.focus(); }, 120);

  </script>
</body>









  
</html>
